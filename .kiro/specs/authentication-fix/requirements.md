# 需求文档

## 介绍

协和医院SCI期刊分析系统存在认证问题，用户登录admin后，点击文献管理菜单中的批量导入按钮时会跳转到登录界面。这个问题影响了用户体验，需要系统性地修复认证机制，确保用户在有效登录状态下能够正常访问所有功能。

## 需求

### 需求 1 - Token持久化和验证

**用户故事：** 作为已登录的用户，我希望在浏览器会话期间保持登录状态，以便能够正常访问系统的所有功能而不被意外退出。

#### 验收标准

1. 当用户成功登录时，系统应当将有效的JWT token保存到localStorage中
2. 当用户刷新页面时，系统应当自动验证存储的token并恢复用户登录状态
3. 当token过期时，系统应当提示用户重新登录而不是静默跳转
4. 当token无效时，系统应当清除本地存储并引导用户到登录页面
5. 系统应当在每次API请求时自动附加有效的Authorization头

### 需求 2 - API请求拦截器优化

**用户故事：** 作为开发者，我希望API请求拦截器能够正确处理认证token，以便确保所有需要认证的请求都能正常工作。

#### 验收标准

1. 当发送API请求时，拦截器应当自动从localStorage获取token并添加到请求头
2. 当API返回401错误时，拦截器应当清除无效token并重定向到登录页
3. 当API返回403错误时，拦截器应当显示权限不足的提示信息
4. 当网络错误或服务器错误时，拦截器应当显示相应的错误提示
5. 拦截器应当支持文件上传请求的特殊处理（multipart/form-data）

### 需求 3 - 路由保护机制增强

**用户故事：** 作为用户，我希望在访问受保护的页面时，系统能够正确验证我的登录状态和权限，以便提供流畅的用户体验。

#### 验收标准

1. 当用户访问受保护路由时，系统应当验证用户的认证状态
2. 当用户未登录时，系统应当重定向到登录页面并保存原始访问路径
3. 当用户登录成功后，系统应当重定向到原始访问路径
4. 当用户权限不足时，系统应当显示权限不足页面而不是跳转到登录页
5. 系统应当在加载状态下显示适当的加载指示器

### 需求 4 - 认证状态同步

**用户故事：** 作为用户，我希望在多个浏览器标签页中的登录状态能够保持同步，以便提供一致的用户体验。

#### 验收标准

1. 当用户在一个标签页中登录时，其他标签页应当自动更新登录状态
2. 当用户在一个标签页中退出时，其他标签页应当自动更新为未登录状态
3. 当token在一个标签页中过期时，其他标签页应当同步更新状态
4. 系统应当监听localStorage的变化来实现状态同步
5. 状态同步应当不影响用户当前的操作流程

### 需求 5 - 错误处理和用户反馈

**用户故事：** 作为用户，我希望当认证出现问题时，系统能够提供清晰的错误信息和解决建议，以便我知道如何处理。

#### 验收标准

1. 当token过期时，系统应当显示"登录已过期，请重新登录"的提示
2. 当网络连接问题导致认证失败时，系统应当显示网络错误提示
3. 当服务器认证服务异常时，系统应当显示服务异常提示
4. 当权限不足时，系统应当显示具体的权限要求信息
5. 所有错误提示应当提供重试或解决问题的操作建议

### 需求 6 - 批量导入功能认证修复

**用户故事：** 作为admin用户，我希望能够正常访问文献管理菜单中的批量导入功能，以便完成文献数据的批量导入工作。

#### 验收标准

1. 当admin用户点击批量导入按钮时，系统应当正常跳转到导入页面
2. 当用户在导入页面进行操作时，所有API请求应当正确携带认证信息
3. 当文件上传请求发送时，系统应当正确处理multipart/form-data格式的认证
4. 当导入过程中出现认证问题时，系统应当提供明确的错误信息
5. 导入功能应当支持所有有权限的用户角色（admin、department_admin）

### 需求 7 - 后端认证中间件优化

**用户故事：** 作为系统，我希望后端认证中间件能够正确处理各种认证场景，以便为前端提供可靠的认证服务。

#### 验收标准

1. 当请求缺少Authorization头时，中间件应当返回明确的401错误
2. 当token格式不正确时，中间件应当返回相应的错误信息
3. 当token过期时，中间件应当返回token过期的特定错误码
4. 当用户被禁用时，中间件应当拒绝访问并返回相应错误
5. 中间件应当正确处理文件上传请求的认证验证